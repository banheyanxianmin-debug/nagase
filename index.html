<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>長瀬 → 大阪上本町（上り）</title>

  <!-- サイトアイコン設定 -->
  <link rel="icon" type="image/png" sizes="32x32" href="icon-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-512.png">
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      background-color: #000;
      color: #FFF;
      font-family: "メイリオ", "Meiryo", monospace;
      margin: 0;
      padding: 0;
    }

    /* --- 遅延バナー用スタイル --- */
    #delayBanner {
      display: none; /* JSで表示/非表示を切替 */
      text-align: center;
      padding: 8px 10px;
      font-weight: bold;
      color: #fff;
      background: #b30000; /* 赤系：遅延あり */
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      position: sticky;
      top: 0;
      z-index: 999;
    }
    #delayBanner.ok {
      background: #225522; /* 平常時（緑系） */
      color: #dfffe0;
    }

    .board {
      width: 95%;
      max-width: 1000px;
      margin: 40px auto;
      padding: 30px;
      border: 4px solid #444;
      box-shadow: 0 0 20px rgba(0,255,0,0.7);
      background-color: #000;
    }

    .title {
      font-size: 3em;
      color: #66FF66;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 0 8px #66FF66;
    }

    .line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 2.2em;
      padding: 15px 0;
      border-top: 1px solid #444;
      white-space: nowrap;
    }

    .label {
      flex: 2;
      text-align: left;
      color: #88FF88;
      min-width: 300px;
    }

    .time {
      flex: 1.2;
      text-align: center;
      color: #FFFF66;
      position: relative;
    }

    .countdown {
      flex: 1.5;
      text-align: right;
      color: #FFAA00;
    }

    .small {
      font-size: 1.5em;
      color: #AAAAAA;
      text-align: center;
      margin-top: 20px;
    }

    .current {
      font-size: 2.5em;
      font-weight: bold;
      margin-top: 40px;
      text-align: center;
      color: #66CCFF;
    }

    .last {
      color: red;
      font-size: 0.6em;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <!-- ここが遅延表示エリア -->
  <div id="delayBanner" aria-live="polite"></div>

  <div class="board">
    <div class="title">長瀬 → 大阪上本町（上り）</div>

    <div class="line" id="nextLine">
      <div class="label">次　　普通　大阪上本町</div>
      <div class="time" id="nextTrainTime">--:--</div>
      <div class="countdown" id="countdown">あと -- 分 -- 秒</div>
    </div>

    <div class="line" id="secondLine">
      <div class="label">次々　普通　大阪上本町</div>
      <div class="time" id="secondTrainTime">--:--</div>
      <div class="countdown" id="secondCountdown">あと -- 分 -- 秒</div>
    </div>

    <div class="current" id="currentTime">現在時刻：--:--:--</div>
    <div class="small" id="dayLabel">平日ダイヤ／休日ダイヤ</div>
    <div class="small">※祝日は正しく機能しない場合があります。</div>
  </div>

  <script>
    /* ---------- 時刻表示ロジック ---------- */
    const weekdayTimes = [
      "05:17","05:34","05:50","06:08","06:24","06:33","06:46","06:59",
      "07:15","07:32","07:46","07:55","08:10","08:21","08:35","08:48",
      "09:01","09:11","09:21","09:29","09:37","09:50","10:01","10:15",
      "10:27","10:33","10:44","11:00","11:07","11:19","11:32","11:46","11:58",
      "12:08","12:24","12:34","12:46","13:00","13:08","13:24","13:34","13:46",
      "14:00","14:07","14:24","14:34","14:46","15:01","15:07","15:19","15:25",
      "15:34","15:46","16:01","16:08","16:25","16:34","16:43","16:47","16:52",
      "17:00","17:09","17:17","17:27","17:39","17:51","18:02","18:15","18:22",
      "18:31","18:36","18:42","18:53","19:07","19:19","19:31","19:44","19:58",
      "20:03","20:17","20:30","20:42","20:59","21:08","21:19","21:29","21:42",
      "21:50","22:05","22:16","22:33","22:47","23:02","23:10","23:26","23:39","23:50"
    ];

    const holidayTimes = [
      "05:17","05:34","05:52","06:08","06:27","06:44","06:57",
      "07:13","07:30","07:39","07:52","08:07","08:15","08:28","08:37",
      "08:49","09:04","09:16","09:27","09:38","09:50","10:07","10:17",
      "10:30","10:46","11:03","11:18","11:34","11:47","12:00","12:09",
      "12:24","12:34","12:46","13:00","13:07","13:24","13:34","13:48",
      "14:00","14:07","14:24","14:34","14:46","15:00","15:07","15:24",
      "15:34","15:46","16:00","16:07","16:24","16:34","16:49","17:03",
      "17:11","17:24","17:31","17:45","17:59","18:09","18:19","18:32",
      "18:46","18:58","19:11","19:18","19:35","19:43","19:52","20:02",
      "20:16","20:32","20:40","20:53","21:06","21:18","21:33","21:44",
      "21:59","22:17","22:29","22:43","23:04","23:18","23:32","23:39","23:50"
    ];

    function pad(n){return n.toString().padStart(2,'0');}
    function timeStringToDate(str,base){
      const[h,m]=str.split(":").map(Number);
      return new Date(base.getFullYear(),base.getMonth(),base.getDate(),h,m);
    }
    function getUpcomingTimes(now,list){
      let next=null,after=null;
      for(let i=0;i<list.length;i++){
        const t=timeStringToDate(list[i],now);
        if(t>now){next=t;if(i+1<list.length){after=timeStringToDate(list[i+1],now);}break;}
      }
      if(!next)next=timeStringToDate(list[0],new Date(now.getFullYear(),now.getMonth(),now.getDate()+1));
      return{next,after};
    }
    function updateBoard(){
      const now=new Date();
      const day=now.getDay();
      const useHoliday=(day===0||day===6);
      document.getElementById("dayLabel").textContent=useHoliday?"休日ダイヤを使用中（土・日）":"平日ダイヤを使用中";
      const times=useHoliday?holidayTimes:weekdayTimes;
      const{next,after}=getUpcomingTimes(now,times);
      const diffNext=next-now;
      const min1=Math.floor(diffNext/60000);
      const sec1=Math.floor((diffNext%60000)/1000);
      const lastTime=timeStringToDate(times[times.length-1],now).getTime();
      const isNextLast=next.getTime()===lastTime;
      const isAfterLast=after&&after.getTime()===lastTime;
      document.getElementById("nextTrainTime").innerHTML=
        `${pad(next.getHours())}:${pad(next.getMinutes())}${isNextLast?'<span class="last">（終電）</span>':""}`;
      document.getElementById("countdown").textContent=`あと ${min1}分 ${sec1}秒`;
      if(after&&!isNextLast){
        const diffAfter=after-now;
        const min2=Math.floor(diffAfter/60000);
        const sec2=Math.floor((diffAfter%60000)/1000);
        document.getElementById("secondTrainTime").innerHTML=
          `${pad(after.getHours())}:${pad(after.getMinutes())}${isAfterLast?'<span class="last">（終電）</span>':""}`;
        document.getElementById("secondCountdown").textContent=`あと ${min2}分 ${sec2}秒`;
      }else{
        document.getElementById("secondTrainTime").textContent="";
        document.getElementById("secondCountdown").textContent="";
      }
      document.getElementById("currentTime").textContent=`現在時刻：${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    }
    setInterval(updateBoard,1000);updateBoard();
  </script>

  <!-- 遅延取得用スクリプト -->
  <script>
    // VercelにデプロイしたAPIのURL
    const API_URL = "https://nagase-lbfame0m1-banheyanxianmin-debugs-projects.vercel.app/";

    async function updateDelayBanner() {
      const banner = document.getElementById("delayBanner");
      try {
        const res = await fetch(API_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("API returned " + res.status);
        const data = await res.json();

        if (data && data.delay) {
          // 遅延あり
          banner.textContent = `🚨 近鉄大阪線：遅延情報あり（${(data.foundKeywords||[]).join(", ") || "詳細あり"}）`;
          banner.style.display = "block";
          banner.classList.remove("ok");
        } else {
          // 平常運行
          banner.textContent = "✅ 近鉄大阪線：平常運行";
          banner.style.display = "block";
          banner.classList.add("ok");
        }
      } catch (e) {
        console.error("delay API error:", e);
        banner.textContent = "遅延情報を取得できません（ネットワーク/APIエラー）";
        banner.style.display = "block";
        banner.classList.remove("ok");
      }
    }

    updateDelayBanner();
    setInterval(updateDelayBanner, 60 * 1000);
  </script>
</body>
</html>
